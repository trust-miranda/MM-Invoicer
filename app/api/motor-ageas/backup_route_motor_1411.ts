import { NextResponse } from "next/server";
import sql from "mssql";

const config = {
  server: "192.168.1.240",
  database: "TRUST_GESTAO_CLINICA_PROD",
  user: "5033",
  password: "manel123456",
  options: {
    encrypt: false,
    enableArithAbort: true,
    requestTimeout: 600000,
  },
};

export async function GET() {
  try {
    const pool = await sql.connect(config);
    const result = await pool.request().query(`
WITH Headers AS (       
SELECT NEWID() as id,
pc.identidadeseguradora as identidade,
en.nomeExterno as seguradora,
cl.nome as nomesinistrado,
pc.idRamo as idRamo,
pes.estadoSinistro as estadoSinistro,
pec.estadoClinico as estadoClinico,
pc.ePensionista as pensionista,
pc.dataAdmissao as dataadmissao,
pc.dataalta as dataalta,
pc.idprocesso as idprocesso,
pc.numapolice as numapolice,
pc.numprocseguradora as numprocseguradora
FROM processoClinico pc WITH (NOLOCK)
LEFT JOIN cliente cl WITH (NOLOCK) ON pc.idcliente = cl.idcliente
LEFT JOIN processoEstadoClinico pec WITH (NOLOCK) ON pc.idProcessoEstadoClinico=pec.idProcessoEstadoClinico
LEFT JOIN processoEstadoSinistro pes WITH (NOLOCK) ON pc.idProcessoEstadoClinico=pes.idProcessoEstadoSinistro
LEFT JOIN entidade en WITH (NOLOCK) ON pc.idEntidadeSeguradora=en.idEntidade
WHERE pc.idprocesso IN (387220,
477445,
498022,
500774,
502690,
507121,
521040,
521133,
527080,
528257,
529027,
530753,
531550,
531782,
533256,
533828,
535175,
536261,
536987,
537023,
537037,
537796,
538290,
538362,
538619,
539177,
539676,
539867,
539984,
540054,
526893,
540226,
540291,
540437,
540479,
540609,
541006,
541208,
541243,
541331,
541349,
541652,
541997,
542023,
542116,
542176,
542184,
542317,
542599,
542628,
542636,
542644,
542661,
542706,
542778,
542951,
543084,
543279,
543419,
543447,
543484,
543604,
543762,
543775,
543853,
543941,
543992,
544020,
544025,
544232,
544331,
544585,
544586,
544730,
544778,
544848,
544862,
544882,
544887,
544952,
544996,
545095,
545127,
545171,
545199,
545314,
545320,
545405,
545482,
545599,
545604,
545617,
545637,
545645,
545667,
545678,
545783,
545836,
545899,
545900,
545905,
545938,
546038,
546101,
546183,
546376,
546387,
546427,
546514,
546571,
546602,
546644,
546659,
546674,
546698,
546723,
546861,
546942,
546947,
546981,
547001,
547024,
547044,
547102,
547181,
547289,
547327,
547490,
547491,
547764,
547830,
547909,
547917,
547920,
548018,
548096,
548098,
548161,
548175,
548238,
548303,
548317,
548393,
548415,
548417,
548434,
548473,
548554,
548573,
548580,
548675,
548723,
548747,
548785,
548813,
548816,
548821,
548834,
548839,
548877,
548898,
549044,
549063,
549092,
549102,
549114,
549129,
549136,
549143,
549146,
549151,
549155,
549171,
549187,
549211,
549221,
549222,
549224,
549249,
549261,
549292,
549349,
549391,
549410,
549411,
549414,
549472,
549490,
549521,
549529,
549554,
549659,
549678,
549693,
549709,
549731,
549784,
549830,
549836,
549846,
549860,
549952,
549980,
550017,
550039,
550065,
550066,
550069,
550085,
550094,
550134,
550135,
550148,
550169,
550170,
550199,
550205,
550223,
550268,
550312,
550314,
550315,
550570,
550598,
550632,
550644,
550749,
550794,
550854,
550920,
550957,
550968,
551061,
551095,
551148,
551292,
551302,
551342,
551392,
551468,
551491,
551511,
551543,
551590,
551695,
551747,
551940,
551966,
551981,
552144,
552318,
552541,
562688)),

ResultLinhas AS (
SELECT 
LTRIM(RTRIM(u.nutente)) as idProcesso,
'' as idLinha,
u.ref as ref,
u.design as descricao,
u.qtt as qtt,
u.valor as valorunit,
bi.lobs2 as idrequisicao,
'' as idrequisicaoactomedico,
'1723849200' as datafinal,
'1718665200' as dataopen,
'nao' as texto,
null as idavenca
FROM PHC..u_facturatmp u WITH (NOLOCK)
LEFT JOIN PHC..bi (NOLOCK) ON u.stampo = bi.bistamp
WHERE u.u_facturatmpstamp IN ('MA24072865345,421000722',
'MA24072865345,421000760',
'MA24072865345,421000679',
'MA24072865345,421000634',
'MA24072865345,421000681',
'MA24072865345,421000753',
'MA24072865345,421000708',
'MA24072865345,421001146',
'MA24072865345,421001269',
'MA24072865345,421002177',
'MA24072865345,421002929',
'MA24072865345,421000899',
'MA24072865345,421000833',
'MA24072865345,421001008',
'MA24072865345,421002453',
'MA24072865345,421001783',
'MA24072865345,421001515',
'MA24072865345,421003748',
'MA24072865345,421004477',
'MA24072865345,421001423',
'MA24072865345,421001813',
'MA24072865345,421002442',
'MA24072865345,421000869',
'MA24072865345,421006774',
'MA24072865345,421001163',
'MA24072865345,421001236',
'MA24072865345,421000691',
'MA24072865345,421000764',
'MA24072865345,421008576',
'MA24072865345,421000619',
'MA24111255054,672008646',
'MA24111255054,672009611',
'MA24111255054,672016038',
'MA24111255054,672016453',
'MA24111255054,672011546',
'MA24111255054,672014419',
'MA24111255054,672010444',
'MA24111255054,672008855',
'MA24111255054,672010967',
'MA24111255054,672013151',
'MA24111255054,672009195',
'MA24111255054,672009419',
'MA24111255054,672014158',
'MA24111255054,672014581',
'MA24111255054,672018317',
'MAM24111250982,1750000-1',
'MA24111255054,672013160',
'MA24072865345,421009035',
'MA24072865345,421008011',
'MA24072865345,421003834',
'MA24072865345,421005104',
'MA24072865345,421003835',
'MA24072865345,421005374',
'MA24072865345,421003920',
'MA24072865345,421003739',
'MA24072865345,421007969',
'MA24111255054,672016526',
'MA24111255054,672016457',
'MA24111255054,672010589',
'MA24111255054,672014076',
'MAM24111250995,0660000-1',
'MA24111255054,672014792',
'MA24111255054,672015720',
'MA24111255054,672013221',
'MA24111255054,672014078',
'MA24111255054,672014077',
'MA24111255054,672012706',
'MA24111255054,672014584',
'MA24111255054,672014585',
'MA24111255054,672015262',
'MAM24111251038,9560000-1',
'MA24111255054,672012618',
'MA24111255054,672016650',
'MAM24111251022,1600000-1',
'MA24111255054,672010302',
'MA24111255054,672011368',
'MA24111255054,672014797',
'MA24072865345,421004606',
'MA24072865345,421005391',
'MA24073008232,226000022',
'MA24072865345,421005969',
'MA24111255054,672012057',
'MAM24111251012,9410000-1',
'MA24111255054,672010483',
'MA24111255054,672010486',
'MA24111255054,672015997',
'MA24111255054,672010481',
'MA24111255054,672010480',
'MA24111255054,672010484',
'MA24111255054,672010482',
'MA24111255054,672010812',
'MA24111255054,672011337',
'MA24111255054,672010670',
'MA24111255054,672011335',
'MA24111255054,672010811',
'MA24111255054,672011336',
'MA24111255054,672011555',
'MA24111255054,672013667',
'MA24111255054,672015181',
'MA24111255054,672014400',
'MA24111255054,672015684',
'MA24111255054,672011192',
'MA24111255054,672014242',
'MA24111255054,672014771',
'MA24111255054,672014004',
'MAM24111251017,2380000-1',
'MA24111255054,672011021',
'MA24111255054,672011060',
'MA24111255054,672015604',
'MA24111255054,672011002',
'MA24111255054,672012048',
'MA24111255054,672012960',
'MA24111255054,672015258',
'MA24111255054,672011770',
'MA24111255054,672014055',
'MA24111255054,672014823',
'MAM24111250949,6280000-1',
'MA24111255054,672011146',
'MA24111255054,672016695',
'MAM24111250972,4250000-1',
'MA24072865345,421006239',
'MA24111255054,672011665',
'MA24111255054,672015229',
'MA24111255054,672011635',
'MA24111255054,672013487',
'MAM24111250986,9720000-1',
'MA24111255054,672011352',
'MA24111255054,672014756',
'MA24111255054,672013814',
'MA24111255054,672011414',
'MA24111255054,672013758',
'MA24111255054,672014258',
'MA24111255054,672014603',
'MA24111255054,672013887',
'MA24111255054,672014061',
'MA24111255054,672013453',
'MA24111255054,672012120',
'MA24111255054,672012121',
'MA24111255054,672012122',
'MAM24111251008,3160000-1',
'MA24111255054,672011469',
'MA24111255054,672015663',
'MA24111255054,672013495',
'MA24111255054,672013915',
'MA24111255054,672014027',
'MA24111255054,672014830',
'MAM24111250961,7690000-1',
'MA24111255054,672011503',
'MA24111255054,672015789',
'MA24111255054,672011584',
'MA24111255054,672016050',
'MA24111255054,672014169',
'MA24111255054,672011598',
'MA24111255054,672014389',
'MA24111255054,672014114',
'MA24111255054,672015152',
'MAM24111250951,0500000-1',
'MA24111255054,672013401',
'MA24111255054,672011811',
'MA24111255054,672015253',
'MA24111255054,672011765',
'MA24111255054,672014709',
'MA24111255054,672014710',
'MAM24111250960,9720000-1',
'MA24111255054,672013467',
'MA24111255054,672015582',
'MA24111255054,672013635',
'MA24111255054,672015188',
'MA24111255054,672016535',
'MA24111255054,672015689',
'MA24111255054,672013916',
'MA24111255054,672014089',
'MA24111255054,672014802',
'MA24111255054,672013792',
'MA24111255054,672012261',
'MA24111255054,672012067',
'MA24111255054,672012068',
'MA24111255054,672015432',
'MAM24111250967,9100000-1',
'MA24111255054,672013050',
'MA24111255054,672013860',
'MA24111255054,672012263',
'MAM24111250995,3780000-1',
'MA24111255054,672013830',
'MA24111255054,672015233',
'MA24111255054,672015639',
'MA24111255054,672014732',
'MA24111255054,672012265',
'MAM24111251022,0970000-1',
'MA24111255054,672013895',
'MA24111255054,672015012',
'MA24111255054,672015692',
'MAM24111250973,1440000-1',
'MA24111255054,672013933',
'MA24111255054,672014415',
'MA24111255054,672011807',
'MA24111255054,672015252',
'MAM24111250987,1130000-1',
'MA24111255054,672013896',
'MA24111255054,672014392',
'MA24111255054,672015234',
'MA24111255054,672015941',
'MA24111255054,672015524',
'MA24111255054,672016476',
'MAM24111251008,5970000-1',
'MA24111255054,672014608',
'MA24111255054,672014753',
'MA24111255054,672015238',
'MA24111255054,672015237',
'MA24111255054,672015461',
'MA24111255054,672015460',
'MA24111255054,672015020',
'MA24111255054,672016139',
'MA24111255054,672014138',
'MA24111255054,672011683',
'MA24111255054,672014272',
'MAM24111250997,5970000-1',
'MA24111255054,672013077',
'MA24111255054,672011682',
'MA24111255054,672014039',
'MA24111255054,672014042',
'MA24111255054,672014273',
'MA24111255054,672014274',
'MA24111255054,672014040',
'MA24111255054,672014041',
'MAM24111251026,1750000-1',
'MA24111255054,672014018',
'MA24111255054,672014404',
'MA24111255054,672016656',
'MA24111255054,672016274',
'MA24111255054,672011983',
'MA24111255054,672016581',
'MAM24111250988,8310000-1',
'MA24111255054,672015641',
'MA24111255054,672014778',
'MA24111255054,672015215',
'MA24111255054,672014757',
'MA24111255054,672015462',
'MA24111255054,672015463',
'MA24111255054,672015465',
'MA24111255054,672015467',
'MA24111255054,672015464',
'MA24111255054,672015466',
'MA24111255054,672015892',
'MAM24111251032,6750000-1',
'MA24111255054,672018437',
'MA24111255054,672015711',
'MA24111255054,672014104',
'MA24111255054,672014672',
'MA24111255054,672016537',
'MA24111255054,672016375',
'MAM24111250963,1130000-1',
'MA24111255054,672011706',
'MA24111255054,672011700',
'MA24111255054,672011698',
'MA24111255054,672011699',
'MA24111255054,672015027',
'MA24111255054,672011701',
'MA24111255054,672015943',
'MAM24111251036,2220000-1',
'MA24111255054,672011705',
'MA24111255054,672014539',
'MA24111255054,672016619',
'MAM24111250950,5030000-1',
'MA24111255054,672014304',
'MA24111255054,672014200',
'MA24111255054,672014201',
'MA24111255054,672014822',
'MA24111255054,672014821',
'MA24111255054,672011909',
'MA24111255054,672015674',
'MA24111255054,672015175',
'MA24111255054,672016064',
'MA24111255054,672014464',
'MA24111255054,672015271',
'MA24111255054,672011845',
'MAM24111250945,5500000-1',
'MA24111255054,672014309',
'MAM24111250996,9720000-1',
'MAM24111250981,1280000-1',
'MA24111255054,672014337',
'MA24111255054,672011740',
'MA24111255054,672016538',
'MA24111255054,672011984',
'MA24111255054,672015328',
'MA24111255054,672015835',
'MA24111255054,672012267',
'MAM24111251028,3470000-1',
'MA24111255054,672014311',
'MA24111255054,672015273',
'MA24111255054,672014505',
'MA24111255054,672011022',
'MAM24111250999,4880000-1',
'MA24111255054,672015642',
'MA24111255054,672018245',
'MA24111255054,672014312',
'MA24111255054,672015493',
'MA24111255054,672011788',
'MA24111255054,672011786',
'MA24111255054,672011787',
'MA24111255054,672011283',
'MAM24111250987,7380000-1',
'MA24111255054,672014338',
'MA24111255054,672015086',
'MA24111255054,672014465',
'MAM24111250992,3630000-1',
'MA24111255054,672014339',
'MA24111255054,672014617',
'MA24111255054,672015768',
'MA24111255054,672015228',
'MA24111255054,672014427',
'MA24111255054,672013447',
'MA24111255054,672011986',
'MAM24111250990,2530000-1',
'MA24111255054,672014414',
'MA24111255132,577000028',
'MA24111255132,577000029',
'MA24111255054,672014838',
'MA24111255132,577000027',
'MA24111255054,672012071',
'MAM24111250949,6440000-1',
'MA24111255054,672015045',
'MA24111255054,672015729',
'MA24111255054,672014840',
'MA24111255054,672014754',
'MA24111255054,672016276',
'MA24111255054,672015728',
'MAM24111251011,8310000-1',
'MA24111255054,672014474',
'MA24111255054,672014886',
'MAM24111250998,2220000-1',
'MA24111255054,672014475',
'MA24111255054,672014469',
'MA24111255054,672011789',
'MA24111255054,672016277',
'MA24111255054,672014922',
'MA24111255054,672015162',
'MA24111255054,672011988',
'MA24111255054,672014785',
'MAM24111250982,9560000-1',
'MA24111255054,672011754',
'MA24111255054,672014007',
'MAM24111250988,4560000-1',
'MA24111255054,672011752',
'MA24111255054,672011710',
'MA24111255054,672011709',
'MA24111255054,672014933',
'MA24111255054,672014934',
'MA24111255054,672015877',
'MA24111255054,672012042',
'MA24111255054,672015949',
'MA24111255054,672015585',
'MA24111255054,672016378',
'MA24111255054,672015119',
'MA24111255054,672016700',
'MA24111255054,672015331',
'MAM24111250944,1280000-1',
'MA24111255054,672015087',
'MA24111255054,672015583',
'MA24111255054,672015584',
'MA24111255054,672011992',
'MA24111255054,672011991',
'MA24111255054,672011990',
'MAM24111250969,5500000-1',
'MA24111255054,672014694',
'MA24111255054,672014811',
'MA24111255054,672016143',
'MAM24111250996,6130000-1',
'MA24111255054,672014695',
'MA24111255054,672015049',
'MAM24111251004,1440000-1',
'MA24111255054,672015290',
'MA24111255054,672014696',
'MA24111255054,672012073',
'MA24111255054,672012074',
'MA24111255054,672015120',
'MA24111255054,672016280',
'MA24111255054,672015731',
'MAM24111251013,3630000-1',
'MA24111255054,672014697',
'MA24111255054,672014690',
'MA24111255054,672014691',
'MA24111255054,672014692',
'MA24111255054,672014923',
'MA24111255054,672016586',
'MAM24111250965,7690000-1',
'MA24111255054,672014698',
'MA24111255054,672015275',
'MA24111255054,672016379',
'MAM24111251023,3000000-1',
'MA24111255054,672014759',
'MAM24111251042,8470000-1',
'MA24111255054,672014850',
'MA24111255054,672015257',
'MA24111255054,672011816',
'MAM24111251010,2380000-1',
'MA24111255054,672014760',
'MA24111255054,672014788',
'MA24111255054,672014789',
'MA24111255054,672012197',
'MA24111255054,672016663',
'MAM24111251018,8940000-1',
'MA24111255054,672014846',
'MA24111255054,672015527',
'MA24111255054,672014853',
'MA24111255054,672014888',
'MA24111255054,672012198',
'MA24111255054,672015336',
'MA24111255054,672015468',
'MAM24111250947,2530000-1',
'MA24111255054,672014816',
'MAM24111250961,6280000-1',
'MA24111255054,672014928',
'MA24111255054,672015405',
'MAM24111251038,7850000-1',
'MA24111255054,672014817',
'MA24111255054,672015586',
'MAM24111251005,3310000-1',
'MA24111255054,672014815',
'MA24111255054,672015093',
'MA24111255054,672016258',
'MAM24111251006,3630000-1',
'MA24111255054,672014852',
'MA24111255054,672015239',
'MA24111255054,672015837',
'MA24111255054,672016479',
'MA24111255054,672015068',
'MA24111255054,672015406',
'MAM24111250950,9720000-1',
'MA24111255054,672014895',
'MAM24111251015,8310000-1',
'MA24111255054,672014930',
'MA24111255054,672015528',
'MA24111255054,672015165',
'MA24111255054,672016702',
'MA24111255054,672011994',
'MAM24111251034,9880000-1',
'MA24111255054,672011759',
'MA24111255054,672015070',
'MA24111255054,672015470',
'MA24111255054,672012270',
'MAM24111251014,1440000-1',
'MA24111255054,672015435',
'MA24111255054,672015443',
'MA24111255054,672016664',
'MAM24111250949,2850000-1',
'MA24111255054,672016218',
'MA24111255054,672014932',
'MA24111255054,672015200',
'MA24111255054,672016541',
'MA24111255054,672015951',
'MAM24111250979,3000000-1',
'MA24111255054,672015138',
'MA24111255054,672015169',
'MA24111255054,672011758',
'MA24111255054,672014967',
'MA24111255054,672015316',
'MA24111255054,672015315',
'MA24111255054,672015935',
'MA24111255054,672016572',
'MA24111255054,672011824',
'MAM24111251007,1280000-1',
'MA24111255054,672015077',
'MA24111255054,672011760',
'MA24111255054,672015076',
'MA24111255054,672016380',
'MAM24111251014,7220000-1',
'MA24111255054,672011761',
'MA24111255054,672015474',
'MA24111255054,672015473',
'MA24111255054,672011847',
'MAM24111250984,2380000-1',
'MA24111255054,672015217',
'MA24111255054,672015475',
'MAM24111250967,1910000-1',
'MA24111255054,672015170',
'MA24111255054,672015167',
'MA24111255054,672016588',
'MAM24111251034,7850000-1',
'MA24111255054,672011762',
'MA24111255054,672015081',
'MA24111255054,672015082',
'MA24111255054,672015084',
'MA24111255054,672015083',
'MA24111255054,672015952',
'MAM24111251016,2060000-1',
'MA24111255054,672011763',
'MA24111255054,672015085',
'MA24111255054,672015645',
'MA24111255054,672012272',
'MA24111255054,672015646',
'MA24111255054,672015839',
'MA24111255054,672015954',
'MA24111255054,672015590',
'MA24111255054,672015345',
'MAM24111251024,4720000-1',
'MA24111255054,672015696',
'MA24111255054,672015171',
'MA24111255054,672015955',
'MA24111255054,672015589',
'MA24111255054,672012076',
'MA24111255054,672015588',
'MAM24111250989,1910000-1',
'MA24111255054,672015089',
'MA24111255054,672015127',
'MA24111255054,672015895',
'MA24111255054,672012273',
'MA24111255054,672015478',
'MA24111255054,672015735',
'MAM24111251006,7380000-1',
'MA24111255054,672015090',
'MA24111255132,577000023',
'MA24111255132,577000019',
'MA24111255054,672015477',
'MA24111255054,672015734',
'MA24111255054,672016146',
'MA24111255054,672015957',
'MA24111255054,672015956',
'MAM24111251007,6750000-1',
'MA24111255054,672015248',
'MA24111255054,672015437',
'MAM24111250946,3310000-1',
'MA24111255054,672015291',
'MA24111255054,672015530',
'MA24111255054,672016542',
'MA24111255054,672015529',
'MAM24111250947,1750000-1',
'MA24111255054,672015172',
'MA24111255054,672015532',
'MA24111255054,672015647',
'MAM24111250949,8160000-1',
'MA24111255054,672015249',
'MA24111255054,672015244',
'MA24111255054,672015242',
'MA24111255054,672015243',
'MA24111255054,672015841',
'MAM24111251038,5970000-1',
'MA24111255054,672015219',
'MA24111255054,672016703',
'MA24111255054,672015958',
'MA24111255054,672016283',
'MA24111255054,672015348',
'MA24111255054,672015531',
'MA24111255054,672015770',
'MA24111255054,672011849',
'MAM24111250949,4560000-1',
'MA24111255054,672015218',
'MA24111255054,672015211',
'MA24111255054,672015769',
'MA24111255054,672015438',
'MAM24111250948,7380000-1',
'MA24111255054,672015220',
'MA24111255054,672016324',
'MAM24111251030,4560000-1',
'MA24111255054,672015221',
'MA24111255054,672015535',
'MA24111255054,672016284',
'MAM24111251020,1280000-1',
'MA24111255054,672016409',
'MA24111255054,672015360',
'MA24111255054,672012199',
'MA24111255054,672011850',
'MAM24111250969,1750000-1',
'MA24111255054,672015250',
'MA24111255054,672015439',
'MA24111255054,672011851',
'MAM24111250980,9720000-1',
'MA24111255054,672015245',
'MA24111255054,672015920',
'MAM24111250988,5030000-1',
'MA24111255054,672015246',
'MA24111255054,672015506',
'MAM24111250944,2850000-1',
'MA24111255054,672015292',
'MA24111255054,672015280',
'MA24111255054,672015282',
'MA24111255054,672015283',
'MA24111255054,672015281',
'MAM24111250978,8000000-1',
'MA24111255054,672015289',
'MA24111255054,672015287',
'MAM24111250970,2530000-1',
'MA24111255054,672015844',
'MA24111255054,672015481',
'MA24111255054,672015495',
'MA24111255054,672015286',
'MA24111255054,672015285',
'MA24111255054,672011852',
'MA24111255054,672015699',
'MA24111255054,672015843',
'MA24111255054,672012274',
'MAM24111250987,5350000-1',
'MA24111255054,672015359',
'MA24111255054,672015302',
'MA24111255054,672015301',
'MA24111255054,672015303',
'MAM24111250974,2060000-1',
'MA24111255054,672016263',
'MA24111255054,672015288',
'MAM24111251021,8780000-1',
'MA24111255054,672015361',
'MA24111255054,672015737',
'MA24111255054,672015592',
'MAM24111251039,8940000-1',
'MA24111255054,672015362',
'MA24111255054,672015357',
'MA24111255054,672015356',
'MA24111255054,672015593',
'MA24111255054,672016704',
'MA24111255054,672016066',
'MAM24111250982,3310000-1',
'MAM24111250970,2850000-1',
'MA24111255054,672016067',
'MA24111255054,672015649',
'MA24111255054,672015536',
'MA24111255054,672015358',
'MA24111255054,672015363',
'MA24111255054,672015416',
'MA24111255054,672015414',
'MA24111255054,672015417',
'MA24111255054,672015413',
'MA24111255054,672015415',
'MA24111255054,672015412',
'MA24111255054,672016543',
'MA24111255054,672016147',
'MAM24111251011,5660000-1',
'MA24111255054,672015364',
'MA24111255054,672016666',
'MA24111255054,672016482',
'MAM24111250953,7060000-1',
'MA24111255054,672015368',
'MA24111255054,672015418',
'MA24111255054,672012275',
'MA24111255054,672015650',
'MAM24111250948,9100000-1',
'MA24111255054,672015664',
'MA24111255054,672016705',
'MA24111255054,672011997',
'MAM24111251014,5970000-1',
'MA24111255054,672015999',
'MA24111255054,672015369',
'MA24111255054,672015652',
'MA24111255054,672015651',
'MA24111255054,672012077',
'MA24111255054,672016381',
'MAM24111251031,8160000-1',
'MA24111255054,672015370',
'MA24111255054,672015653',
'MA24111255054,672012078',
'MA24111255054,672015487',
'MAM24111251008,3940000-1',
'MA24111255054,672015371',
'MA24111255132,577000011',
'MAM24111251005,8000000-1',
'MA24111255054,672015365',
'MA24111255054,672016522',
'MAM24111251042,1910000-1',
'MA24111255054,672015445',
'MAM24111250949,0810000-1',
'MA24111255054,672015447',
'MA24111255054,672015847',
'MA24111255054,672016483',
'MAM24111251043,0970000-1',
'MA24111255054,672015448',
'MA24111255054,672015703',
'MA24111255054,672012080',
'MAM24111250987,4410000-1',
'MA24111255054,672015491',
'MA24111255054,672015453',
'MA24111255054,672015454',
'MA24111255054,672015451',
'MA24111255054,672016571',
'MAM24111250975,2060000-1',
'MA24111255054,672015449',
'MA24111255054,672011999',
'MAM24111251004,3940000-1',
'MA24111255054,672015551',
'MA24111255054,672015655',
'MA24111255054,672015656',
'MA24111255054,672016706',
'MAM24111250948,4100000-1',
'MA24111255054,672015501',
'MAM24111250996,5350000-1',
'MA24111255054,672015544',
'MA24111255054,672015507',
'MAM24111250999,8160000-1',
'MA24111255054,672015552',
'MA24111255054,672015740',
'MA24111255054,672015741',
'MA24111255054,672016591',
'MA24111255054,672016285',
'MAM24111250982,8310000-1',
'MA24111255054,672015553',
'MA24111255054,672016154',
'MA24111255054,672015959',
'MA24111255054,672016037',
'MA24111255054,672015621',
'MA24111255054,672016570',
'MAM24111251009,1910000-1',
'MA24111255054,672015546',
'MA24111255054,672015620',
'MAM24111250965,6280000-1',
'MA24111255054,672015910',
'MA24111255054,672015554',
'MA24111255054,672015705',
'MA24111255054,672016707',
'MAM24111250973,9560000-1',
'MA24111255054,672015607',
'MA24111255054,672015900',
'MAM24111251030,8630000-1',
'MA24111255054,672015555',
'MAM24111250979,1600000-1',
'MA24111255054,672015608',
'MAM24111250956,3940000-1',
'MA24111255054,672015609',
'MA24111255054,672015602',
'MA24111255054,672015603',
'MA24111255054,672016287',
'MAM24111250961,8940000-1',
'MA24111255054,672015605',
'MA24111255054,672016369',
'MAM24111251013,8630000-1',
'MA24111255054,672016410',
'MA24111255054,672015610',
'MA24111255054,672016484',
'MAM24111251015,5190000-1',
'MA24111255054,672015661',
'MA24111255054,672015613',
'MAM24111250981,5660000-1',
'MA24111255054,672015668',
'MAM24111250944,4410000-1',
'MA24111255054,672015669',
'MA24111255054,672015963',
'MAM24111251009,2690000-1',
'MA24111255054,672015758',
'MA24111255054,672015744',
'MA24111255054,672016485',
'MAM24111250968,7380000-1',
'MA24111255054,672015670',
'MA24111255054,672015660',
'MA24111255054,672011825',
'MA24111255054,672016648',
'MA24111255054,672015818',
'MAM24111250998,6440000-1',
'MA24111255054,672015662',
'MAM24111251008,4100000-1',
'MA24111255054,672015712',
'MA24111255054,672011797',
'MA24111255054,672011796',
'MA24111255054,672011798',
'MAM24111251025,3470000-1',
'MA24111255054,672015713',
'MAM24111250947,9720000-1',
'MA24111255054,672015774',
'MA24111255054,672015779',
'MA24111255054,672015772',
'MA24111255054,672015773',
'MA24111255054,672016288',
'MAM24111251002,0660000-1',
'MA24111255054,672015780',
'MA24111255054,672018267',
'MA24111255054,672018268',
'MAM24111251005,9250000-1',
'MA24111255054,672015756',
'MA24111255054,672015921',
'MA24111255054,672016440',
'MA24111255054,672016592',
'MAM24111250947,3940000-1',
'MA24111255054,672015783',
'MAM24111251032,7530000-1',
'MA24111255054,672015791',
'MA24111255054,672016593',
'MA24111255054,672016594',
'MA24111255054,672016595',
'MA24111255054,672016358',
'MA24111255054,672016161',
'MAM24111250971,3310000-1',
'MA24111255054,672016220',
'MA24111255054,672016523',
'MAM24111250960,9880000-1',
'MA24111255054,672015788',
'MAM24111250980,5190000-1',
'MA24111255054,672015793',
'MAM24111251006,9880000-1',
'MA24111255054,672015795',
'MA24111255054,672011804',
'MA24111255054,672012213',
'MA24111255054,672016486',
'MAM24111250968,2060000-1',
'MA24111255054,672016411',
'MA24111255054,672016074',
'MA24111255054,672016545',
'MAM24111250959,9720000-1',
'MA24111255054,672016292',
'MA24111255054,672011805',
'MA24111255054,672015798',
'MAM24111250972,0660000-1',
'MA24111255054,672015800',
'MA24111255054,672015856',
'MAM24111251034,8160000-1',
'MA24111255054,672015802',
'MA24111255054,672016709',
'MA24111255054,672016708',
'MA24111255054,672012216',
'MAM24111250948,6130000-1',
'MA24111255054,672015868',
'MA24111255054,672015825',
'MA24111255054,672016295',
'MA24111255054,672016711',
'MA24111255054,672016667',
'MAM24111250962,9880000-1',
'MA24111255054,672016325',
'MAM24111251024,0350000-1',
'MA24111255054,672015804',
'MA24111255054,672015970',
'MA24111255054,672015969',
'MAM24111250994,6280000-1',
'MA24111255054,672015806',
'MA24111255054,672012005',
'MAM24111250986,9250000-1',
'MA24111255054,672015807',
'MA24111255054,672016668',
'MAM24111251014,2690000-1',
'MA24111255054,672015870',
'MA24111255054,672015865',
'MA24111255054,672015863',
'MA24111255054,672015864',
'MA24111255054,672011862',
'MAM24111251002,5500000-1',
'MA24111255054,672015911',
'MA24111255054,672015902',
'MA24111255054,672012006',
'MA24111255054,672016487',
'MAM24111251019,0350000-1',
'MA24111255054,672012082',
'MA24111255054,672012102',
'MA24111255054,672016546',
'MAM24111250981,5190000-1',
'MA24111255054,672016000',
'MA24111255054,672012218',
'MAM24111250983,4100000-1',
'MA24111255054,672015876',
'MA24111255054,672015866',
'MA24111255054,672015867',
'MA24111255054,672016547',
'MA24111255054,672012084',
'MA24111255054,672016165',
'MAM24111251018,1750000-1',
'MA24111255054,672015875',
'MAM24111250965,4410000-1',
'MA24111255054,672015913',
'MAM24111251031,8940000-1',
'MA24111255054,672015909',
'MA24111255054,672012229',
'MAM24111251000,9560000-1',
'MA24111255054,672015914',
'MA24111255054,672015905',
'MA24111255054,672016601',
'MA24111255054,672016296',
'MA24111255054,672012009',
'MAM24111250982,4410000-1',
'MA24111255054,672016326',
'MAM24111250977,7060000-1',
'MA24111255054,672016002',
'MA24111255054,672016299',
'MAM24111250972,3780000-1',
'MA24111255054,672016327',
'MAM24111251013,9250000-1',
'MA24111255054,672016223',
'MA24111255054,672011940',
'MAM24111251026,0970000-1',
'MA24111255054,672011882',
'MA24111255054,672015908',
'MA24111255054,672016359',
'MAM24111251037,1440000-1',
'MA24111255054,672015918',
'MA24111255054,672012222',
'MA24111255054,672012223',
'MAM24111251011,2220000-1',
'MA24111255054,672016224',
'MA24111255054,672011863',
'MAM24111250949,1600000-1',
'MA24111255054,672015991',
'MAM24111250989,1130000-1',
'MA24111255054,672015989',
'MA24111255054,672011813',
'MAM24111251019,2060000-1',
'MA24111255054,672016007',
'MA24111255054,672016623',
'MA24111255054,672016383',
'MAM24111250983,8000000-1',
'MA24111255054,672015992',
'MAM24111250996,6600000-1',
'MA24111255054,672016008',
'MA24111255054,672012227',
'MA24111255054,672015974',
'MAM24111250974,1600000-1',
'MA24111255054,672016081',
'MAM24111250989,2850000-1',
'MA24111255054,672016011',
'MAM24111251003,5190000-1',
'MA24111255054,672016079',
'MA24111255054,672016041',
'MAM24111251039,1910000-1',
'MA24111255054,672015924',
'MA24111255054,672015988',
'MA24111255054,672011812',
'MAM24111250962,7850000-1',
'MA24111255054,672016082',
'MA24111255054,672016264',
'MA24111255054,672016644',
'MAM24111251032,4560000-1',
'MA24111255054,672015990',
'MA24111255054,672011906',
'MAM24111250971,7060000-1',
'MA24111255054,672016012',
'MA24111255054,672015976',
'MA24111255054,672016714',
'MA24111255054,672016713',
'MA24111255054,672012228',
'MA24111255054,672011945',
'MA24111255054,672016257',
'MAM24111251010,4100000-1',
'MA24111255054,672016564',
'MA24111255054,672016077',
'MAM24111250952,7530000-1',
'MA24111255054,672016014',
'MA24111255054,672012086',
'MA24111255054,672016178',
'MA24111255054,672011864',
'MAM24111250994,4100000-1',
'MA24111255054,672016225',
'MAM24111251001,7690000-1',
'MA24111255054,672016015',
'MA24111255054,672015981',
'MA24111255054,672015978',
'MA24111255054,672015979',
'MA24111255054,672015980',
'MAM24111250969,8160000-1',
'MA24111255054,672016412',
'MA24111255054,672011865',
'MAM24111250985,9880000-1',
'MA24111255054,672015983',
'MA24111255054,672011866',
'MA24111255054,672016016',
'MA24111255054,672015982',
'MA24111255054,672016183',
'MAM24111251002,0030000-1',
'MA24111255054,672015986',
'MA24111255054,672016182',
'MA24111255054,672016017',
'MA24111255054,672016181',
'MA24111255054,672016180',
'MA24111255054,672016179',
'MAM24111251026,9410000-1',
'MA24111255054,672016019',
'MAM24111250988,1750000-1',
'MA24111255054,672016226',
'MA24111255054,672016185',
'MA24111255054,672011867',
'MA24111255054,672012010',
'MAM24111251004,4720000-1',
'MA24111255054,672016023',
'MAM24111251039,4410000-1',
'MA24111255054,672016403',
'MA24111255054,672016267',
'MAM24111250974,2690000-1',
'MA24111255054,672016084',
'MA24111255054,672016669',
'MAM24111250998,1440000-1',
'MA24111255054,672016085',
'MAM24111250945,3780000-1',
'MA24111255054,672016188',
'MA24111255054,672016303',
'MA24111255054,672016228',
'MA24111255054,672016302',
'MA24111255054,672012088',
'MA24111255054,672012012',
'MA24111255054,672011941',
'MA24111255054,672016548',
'MAM24111250971,1600000-1',
'MA24111255054,672016229',
'MA24111255054,672016230',
'MA24111255054,672016190',
'MA24111255054,672016101',
'MAM24111250950,0350000-1',
'MA24111255054,672011876',
'MAM24111251025,3940000-1',
'MA24111255054,672016088',
'MAM24111251018,7380000-1',
'MA24111255054,672016216',
'MA24111255054,672016121',
'MAM24111251001,8780000-1',
'MA24111255054,672016234',
'MA24111255054,672016192',
'MAM24111251026,5190000-1',
'MA24111255054,672016221',
'MA24111255054,672012083',
'MA24111255054,672011903',
'MA24111255054,672011810',
'MAM24111250990,4250000-1',
'MA24111255054,672016209',
'MAM24111251041,6600000-1',
'MA24111255054,672016235',
'MA24111255054,672011943',
'MAM24111251018,1600000-1',
'MA24111255054,672016239',
'MA24111255054,672016193',
'MAM24111251001,8310000-1',
'MA24111255054,672016240',
'MAM24111250944,2380000-1',
'MA24111255054,672016207',
'MAM24111250958,6600000-1',
'MA24111255054,672016244',
'MA24111255054,672016197',
'MA24111255054,672016198',
'MA24111255054,672016490',
'MA24111255054,672016489',
'MA24111255054,672016670',
'MAM24111250960,5500000-1',
'MAM24111250981,7530000-1',
'MA24111255054,672016247',
'MA24111255054,672016199',
'MA24111255054,672016200',
'MA24111255054,672016304',
'MAM24111250973,1750000-1',
'MA24111255054,672016329',
'MAM24111250991,7690000-1',
'MA24111255054,672016251',
'MA24111255054,672016201',
'MA24111255054,672016202',
'MAM24111250980,1130000-1',
'MA24111255054,672016333',
'MA24111255054,672012280',
'MA24111255054,672012279',
'MA24111255054,672012281',
'MAM24111250996,7060000-1',
'MA24111255054,672016214',
'MA24111255054,672016631',
'MA24111255054,672016362',
'MA24111255054,672016678',
'MAM24111251038,8780000-1',
'MA24111255054,672016208',
'MA24111255054,672016630',
'MAM24111250973,4250000-1',
'MA24111255054,672016334',
'MA24111255054,672016203',
'MAM24111250943,3310000-1',
'MA24111255054,672016205',
'MA24111255054,672011885',
'MA24111255054,672016204',
'MA24111255054,672016603',
'MAM24111250971,4880000-1',
'MAM24111250949,4250000-1',
'MA24111255054,672016256',
'MA24111255054,672012091',
'MA24111255054,672012283',
'MAM24111250966,3310000-1',
'MA24111255054,672012103',
'MA24111255054,672011954',
'MA24111255054,672011818',
'MA24111255054,672011819',
'MAM24111250978,1750000-1',
'MA24111255054,672016319',
'MA24111255054,672012049',
'MAM24111251002,6910000-1',
'MA24111255054,672016322',
'MA24111255054,672016716',
'MA24111255054,672011871',
'MAM24111251033,6910000-1',
'MA24111255054,672011888',
'MAM24111250989,6280000-1',
'MA24111255054,672016321',
'MAM24111251017,1440000-1',
'MA24111255054,672016339',
'MA24111255054,672012094',
'MA24111255054,672012093',
'MA24111255054,672016309',
'MAM24111250959,0190000-1',
'MA24111255054,672016311',
'MA24111255054,672016340',
'MA24111255054,672016310',
'MA24111255054,672012095',
'MAM24111251011,7850000-1',
'MA24111255054,672016342',
'MAM24111250988,8780000-1',
'MA24111255054,672016343',
'MA24111255054,672016312',
'MAM24111251014,4560000-1',
'MA24111255054,672011879',
'MAM24111251035,1130000-1',
'MA24111255054,672016347',
'MA24111255054,672016315',
'MA24111255054,672016313',
'MA24111255054,672016314',
'MA24111255054,672011872',
'MAM24111250974,2530000-1',
'MA24111255054,672011889',
'MA24111255054,672016491',
'MAM24111250981,3160000-1',
'MA24111255054,672016506',
'MA24111255054,672012284',
'MAM24111251034,3780000-1',
'MA24111255054,672012032',
'MA24111255054,672012016',
'MAM24111250985,7380000-1',
'MA24111255054,672012017',
'MA24111255054,672016413',
'MA24111255054,672012015',
'MA24111255054,672012230',
'MA24111255054,672016516',
'MAM24111251005,0970000-1',
'MA24111255054,672016399',
'MA24111255054,672012019',
'MAM24111250963,8630000-1',
'MA24111255054,672012020',
'MA24111255054,672016414',
'MA24111255054,672012018',
'MAM24111251009,7380000-1',
'MA24111255054,672012025',
'MAM24111250966,6600000-1',
'MA24111255054,672016722',
'MA24111255054,672012104',
'MA24111255054,672016441',
'MAM24111251008,7060000-1',
'MA24111255054,672016500',
'MAM24111251020,6600000-1',
'MA24111255054,672012098',
'MA24111255054,672012107',
'MAM24111250989,3780000-1',
'MA24111255054,672012108',
'MA24111255054,672016492',
'MAM24111250952,5660000-1',
'MA24111255054,672012110',
'MA24111255054,672016451',
'MAM24111250972,3310000-1',
'MA24111255054,672016502',
'MAM24111251040,2690000-1',
'MA24111255054,672016420',
'MA24111255054,672012289',
'MA24111255054,672012290',
'MA24111255054,672012288',
'MA24111255054,672016390',
'MAM24111250961,3470000-1',
'MA24111255054,672016610',
'MA24111255054,672016391',
'MA24111255054,672016555',
'MAM24111250966,4100000-1',
'MA24111255054,672016424',
'MAM24111250951,5810000-1',
'MA24111255054,672016429',
'MA24111255054,672016394',
'MA24111255054,672016393',
'MAM24111250953,8630000-1',
'MA24111255054,672016408',
'MA24111255054,672016469',
'MAM24111250994,0660000-1',
'MA24111255054,672016507',
'MA24111255054,672016494',
'MAM24111250957,4100000-1',
'MA24111255054,672016433',
'MA24111255054,672016396',
'MAM24111251031,6600000-1',
'MA24111255054,672016400',
'MA24111255054,672016635',
'MA24111255054,672016517',
'MA24111255054,672016634',
'MA24111255054,672016636',
'MAM24111250988,7220000-1',
'MA24111255054,672016508',
'MA24111255054,672016496',
'MAM24111251003,7220000-1',
'MA24111255054,672016503',
'MA24111255054,672016690',
'MA24111255054,672016498',
'MA24111255054,672016672',
'MAM24111251027,5970000-1',
'MAM24111251031,4720000-1',
'MA24111255054,672016561',
'MA24111255054,672016646',
'MA24111255054,672016688',
'MAM24111251041,0190000-1',
'MA24111255054,672016622',
'MA24111255054,672016557',
'MAM24111250974,0190000-1',
'MA24111255054,672016614',
'MA24111255054,672016558',
'MAM24111251022,9560000-1',
'MA24111255054,672016615',
'MA24111255054,672016559',
'MA24111255054,672016606',
'MAM24111251036,7220000-1',
'MA24111255054,672016723',
'MA24111255054,672016607',
'MAM24111251017,7220000-1',
'MA24111255054,672016627',
'MA24111255054,672016675',
'MAM24111251025,2690000-1',
'MA24111255054,672016726',
'MA24111255054,672016718',
'MA24111255054,672016719',
'MAM24111251020,7850000-1',
'MA24111255054,672016727'))

SELECT h.*, l.idLinha, l.ref, l.descricao, l.qtt, l.valorunit, l.idrequisicao, l.idrequisicaoactomedico, l.datafinal, l.dataopen, l.texto, l.idavenca
FROM Headers h, ResultLinhas l
WHERE h.idprocesso=l.idProcesso 
AND l.valorunit > 0
AND l.qtt > 0
AND h.numprocseguradora > ''
ORDER BY h.idprocesso, l.ref;
        `);

    // Group by idProcesso and add row index for idLinha
    const groupedResult = result.recordset.reduce((acc, row) => {
      const idProcesso = row.idprocesso ? row.idprocesso.toString().trim() : "";

      if (!acc[idProcesso]) {
        acc[idProcesso] = {
          id: row.id ? row.id.toString().trim() : "",
          identidade: row.identidade ? parseInt(row.identidade, 10) : null,
          seguradora: row.seguradora ? row.seguradora.trim() : "",
          nomesinistrado: row.nomesinistrado
            ? row.nomesinistrado.toString().trim()
            : "",
          idRamo: row.idRamo ? row.idRamo.toString().trim() : "",
          estadoSinistro: row.estadoSinistro
            ? row.estadoSinistro.toString().trim()
            : "",
          estadoClinico: row.estadoClinico
            ? row.estadoClinico.toString().trim()
            : "",
          pensionista: row.pensionista ? row.pensionista.toString().trim() : "",
          dataadmissao: row.dataadmissao
            ? row.dataadmissao.toString().trim()
            : null,
          dataalta: row.dataalta ? row.dataalta.toString().trim() : null,
          idprocesso: idProcesso,
          numapolice: row.numapolice ? row.numapolice.toString().trim() : "",
          numprocseguradora: row.numprocseguradora
            ? row.numprocseguradora.toString().trim()
            : "",
          ResultLinhas: [],
          idLinhaCounter: 1,
        };
      }

      acc[idProcesso].ResultLinhas.push({
        idlinha: acc[idProcesso].idLinhaCounter,
        ref: row.ref ? row.ref.toString().trim() : "",
        descricao: row.descricao ? row.descricao.toString().trim() : "",
        qtt: row.qtt || 0,
        valorunit: row.valorunit ? parseFloat(row.valorunit) : 0,
        idrequisicao: row.idrequisicao
          ? row.idrequisicao.toString().trim()
          : "0",
        idrequisicaoactomedico: row.idrequisicaoactomedico
          ? row.idrequisicaoactomedico.toString().trim()
          : "",
        datafinal: row.datafinal ? row.datafinal.toString().trim() : "",
        dataopen: row.dataopen ? row.dataopen.toString().trim() : "",
        idavenca: row.idavenca || null,
      });

      acc[idProcesso].idLinhaCounter += 1;

      return acc;
    }, {});

    const formattedResult = Object.values(groupedResult).map(
      ({ idLinhaCounter, ...rest }) => rest
    );

    return NextResponse.json(formattedResult, { status: 200 });
  } catch (err) {
    console.error("Database query error:", err);
    return NextResponse.json(
      { error: "Database query error" },
      { status: 500 }
    );
  }
}
